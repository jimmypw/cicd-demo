version: v1.0
name: Create Artifacts
agent:
  machine:
    type: e1-standard-2
    os_image: ubuntu2004
blocks:
  - name: Create Artifacts
    task:
      jobs:
        - name: Build and push artifacts
          commands:
            - '#!/bin/bash'
            - 'if [ ! -d "./dist" ]; then'
            - "\tmkdir ./dist"
            - fi
            - 'IMAGELIST=$(grep image deploy.yaml | sed -E ''s/\s+-\ image:\ //g'')'
            - for image in $IMAGELIST; do
            - "\timage_safe=\"${image//[^[:alnum:]]/-}\""
            - "\tdocker pull $image"
            - "\tdocker save $image > ./dist/${image_safe}.tar"
            - done
            - envsubst < deploy.yaml > ./dist/deploy.yaml
            - 'artifactname="${SEMAPHORE_GIT_REPO_NAME}-${SEMAPHORE_GIT_TAG_NAME}.tar.gz"'
            - 'tar cfz ${artifactname} ./dist'
            - 'artifact push job ${artifactname}'
      prologue:
        commands:
          - checkout
