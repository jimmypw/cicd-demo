version: v1.0
name: Deploy to Preprod
agent:
  machine:
    type: e1-standard-2
    os_image: ubuntu2004
blocks:
  - name: Kubectl Apply
    task:
      jobs:
        - name: apply
          commands:
            - checkout
            - envsubst < deploy.yaml | kubectl apply -f -
      secrets:
        - name: k8s-jpw-kubeconfig
      prologue:
        commands:
          - source scripts/extravars.sh
  - name: DNS
    task:
      secrets:
        - name: DNS CONFIG
      prologue:
        commands:
          - source scripts/extravars.sh
      jobs:
        - name: Configure Gandi DNS
          commands:
            - 'scripts/gandi-dns-update.sh ${TLD} ${DEPLOYMENT_URL} ${K8S_INGRESS_IP}'
promotions:
  - name: Production
    pipeline_file: production.yml
